<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GAMU</title>
    <style>
    /* Background and fonts */
    body {
      font-family: Arial, sans-serif;
      background-color: #f5fbff; /* light blue */
      color: #010408;            /* dark blue text */
      margin: 0;
      padding: 20px 20px 20px 300px; /* add left padding for sticky ToC */
    }

    /* Header styles */
    h1 {
      color: #0d47a1;            /* dark blue */
      background-color: #bbdefb; /* medium blue */
      padding: 10px;
      border-radius: 8px;
    }

    h2 {
      color: #1565c0; /* another shade of blue */
    }

    p {
      font-size: 16px;
      font-family: Arial, sans-serif;
      color: #040e1e;
    }

    /* Styling the webR state box */
    #webR-state {
      color: red;                /* make text red */
      font-weight: bold;
    }

    pre {
      background-color: #dcf2fc; /* very light blue */
      border: 1px solid #84c4f9; /* medium blue border */
      padding: 10px;
      border-radius: 5px;
    }

    /* Container margin */
    div {
      margin-top: 20px;
    }

    /* Sticky Table of Contents */
    .toc {
      position: fixed;
      top: 20px;
      left: 20px;
      width: 250px;
      background-color: #bbdefb;
      padding: 5px;
      border-radius: 5px;
      font-size: 16px;
      font-weight: bold;
    }
    .toc h3 {
      margin-top: 0;
      font-size: 16px;
      color: #0d47a1;
    }
    .toc ul {
      list-style-type: none;
      padding-left: 10px;
    }
    .toc li {
      margin-bottom: 5px;
    }
    .toc a {
      color: #0d47a1;
      text-decoration: none;
    }
    .toc a:hover {
      text-decoration: underline;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>
<!-- ################################################### -->
<!-- ################################################### -->
<!-- ############## Start of body of the document ###### -->
<!-- ################################################### -->
<!-- ################################################### -->
<body>
  <!-- Sticky Table of Contents -->
<div class="toc">
  <h3>Table of Contents</h3>
  <ul>
    <li><a href="#datafromzip">1. Load data from a ZIP</a>
      <ul>
        <li><a href="#loadzip">1.1 Upload and extract</a></li>
        <li><a href="#SelectCSV">1.2 Select CSV file</a></li>
        <li><a href="#plot">1.3 Plot data</a></li>
        <li><a href="#lm">1.4 Fit model</a></li>
        <li><a href="#fitplot">1.5 Plot fitted lines</a></li>
        <li><a href="#savedata">1.6 Save the data</a></li>
      </ul>
    </li>
  </ul>
</div>

  <!-- Header of the HTML document -->
  <h1><b>GAMU</b>: Presentation of <code>webR</code> functionalities</h1>
  <h2>How could our app look like</h2>
  <p><b>Tomas Pompa</b></p>
  <p>October 2025</p>
  <!-- Row with current state of the webR -->
  <div>
      <pre><code id="webR-state">Loading webR, please wait...</code></pre>
  </div>

  <!-- script with webR code -->
  <script type="module">
        // ################################################### 
    // ################################################### 
    // ############# initialize webR ##################### 
    // ################################################### 
    // ################################################### 

    import { WebR } from "https://webr.r-wasm.org/latest/webr.mjs";
    const webR = new WebR();
    await webR.init();

    // Load packages and display current webR state
    const outElem = document.getElementById('webR-state');
    outElem.innerText = 'Loading packages, please wait...';
    await webR.installPackages(['dplyr', 'ggplot2'], true);
    const outElem2 = document.getElementById('webR-state');
    outElem2.innerText = 'Everything is ready!';

    //#############################################################
    // Define custom functions
    //#############################################################

    await webR.evalR(`
      # This cell contains definition of the functions used in this document
      GenerateData <- function(N) {
        data <- data.frame(Size = runif(N, 1, 18),
                        Type = sample(c("Class A", "Class B"), N, replace = TRUE))
        data$Width = 1 + 0.8 * data$Size + rnorm(N, sd = 2)
        return(data)
      }

      FitLM <- function(data) {
        model <- lm(Width ~ Size * Type, data = data)
        p <- ggplot(data = data, aes(x = Size, y = Width, color = Type)) + 
          geom_point() + 
          theme_bw() + 
          geom_smooth(method = "lm", se = FALSE)
        print(p)
      }   
    `);

  // ################################################### 
  // ################################################### 
  // ############# Load multiple data from zip ######### 
  // ################################################### 
  // ################################################### 

  //#############################################################
  // 1.1 Load the zip file
  //#############################################################

  // # Define variables
  // ## Variable where the zip file will be stored
  const zipInput = document.getElementById('zipFile');
  // ## Variable for button that uploads the zip
  const uploadZipBtn = document.getElementById('uploadZipBtn');
  // ## Variable for displaying current status
  const zipStatus = document.getElementById('zipStatus');

  // What happens if the user press the button
  uploadZipBtn.addEventListener('click', async () => {
    try {
      if (!zipInput.files || zipInput.files.length === 0) {
        zipStatus.textContent = "Please select a ZIP file first.";
        return;
      }

      const file = zipInput.files[0];
      const arrayBuffer = await file.arrayBuffer();

      zipStatus.textContent = "Extracting ZIP file...";
      const zip = await JSZip.loadAsync(arrayBuffer);

      // Iterate over files in the zip and write them into webR filesystem
      for (const [path, zipEntry] of Object.entries(zip.files)) {
        if (zipEntry.dir) continue; // skip directories
        const content = await zipEntry.async("uint8array");
        const destPath = "/" + path;  // keep folder structure
        // Ensure folder exists in MEMFS
        const dirs = destPath.split("/").slice(1, -1);
        let currentPath = "";
        for (const d of dirs) {
          currentPath += "/" + d;
          try {
            webR.FS.mkdir(currentPath);
          } catch (e) {} // ignore if already exists
        }
        webR.FS.writeFile(destPath, content);
      }

      zipStatus.textContent = "✅ ZIP extracted into webR filesystem.";

      let Before = await webR.evalR(`list.files("/Before", recursive = TRUE)`);
      console.log("Files available in folder Before:", await Before.toArray());
      let After = await webR.evalR(`list.files("/After", recursive = TRUE)`);
      console.log("Files available in folder After:", await After.toArray());

      // Convert to arrays
      let beforeArray = await Before.toArray();
      let afterArray  = await After.toArray();

      // Display in HTML
      document.getElementById("before-files").textContent = beforeArray.length 
        ? beforeArray.join("\n") 
        : "No files found in Before folder.";

      document.getElementById("after-files").textContent = afterArray.length 
        ? afterArray.join("\n") 
        : "No files found in After folder.";

    } catch (err) {
      console.error(err);
      zipStatus.textContent = "Error: " + err.toString();
    }
  });

  //#############################################################
  // 1.2 Select and load csv data
  //#############################################################

  window.SelectCSV = async function() {
      const csv_folder = document.getElementById("SelectedCSVfolder").value || "After";
      const csv_filename = document.getElementById("SelectedCSVfile").value || "data1.csv";

      const outElem1_2a = document.getElementById('SelectCSV-text');
      outElem1_2a.innerText = 'Uploading selected file ...';
    
      await webR.evalRVoid(`data <- read.csv(paste0("/", ${csv_folder}, "/", ${csv_filename}))`);

      const nrows = await (await webR.evalR("nrow(data)")).toArray();

      const outElem1_2b = document.getElementById('SelectCSV-text');
      outElem1_2b.innerText = `✅ Data loaded: ${nrows[0]} rows.`;
    }

    //#############################################################
    // 1.3 Plot the data
    //#############################################################

    window.plotMyData = async function() {
      const graph_title = document.getElementById("graph_title").value || "My Plot";

      const outElem1_3a = document.getElementById('plot-text');
      outElem1_3a.innerText = 'Plotting the graph, please wait ...';
    
      await webR.evalRVoid(`
          library(ggplot2)
          webr::canvas(width=400, height=300)
          
          p1 <- ggplot(data = data, aes(x = Size, y = Width, color = Type)) + 
            geom_point() + 
            theme_bw() + 
            ggtitle(label = as.character(${graph_title}))
          
          print(p1)
          dev.off()
      `);

      const outElem1_3b = document.getElementById('plot-text');
      outElem1_3b.innerText = 'Your graph is ready!';

      const msgs = await webR.flush();
      msgs.forEach(msg => {
        if (msg.type === 'canvas' && msg.data.event === 'canvasImage') {
          const canvas = document.getElementById('my_plot_1');
          canvas.getContext('2d').drawImage(msg.data.image, 0, 0);
        }
      });
    }

    //#############################################################
    // 1.4 Fitting linear model
    //#############################################################

    window.FitLM = async function() {
      const outElem1_4a = document.getElementById('fit-LM');
      outElem1_4a.innerText = 'Fitting the linear model, please wait ...';

      await webR.evalR(`
          model <- lm(Width ~ Size * Type, data = data)
      `);

      // regression coefficients
      const beta022 = await webR.evalR(`coef(model)[1]`);
      const beta122 = await webR.evalR(`coef(model)[2]`);
      const beta222 = await webR.evalR(`coef(model)[3]`);
      const beta322 = await webR.evalR(`coef(model)[4]`);
      // Convert parameters to array
      const output_beta02 = (await beta022.toArray())[0];
      const output_beta12 = (await beta122.toArray())[0];
      const output_beta22 = (await beta222.toArray())[0];
      const output_beta32 = (await beta322.toArray())[0];
      // Specify text for the parameters
      document.getElementById("output_beta02").textContent = "Intercept: " + output_beta02;
      document.getElementById("output_beta12").textContent = "Coefficient for Size: " + output_beta12;
      document.getElementById("output_beta22").textContent = "Coefficient for Type B: " + output_beta22;
      document.getElementById("output_beta32").textContent = "Interaction coefficient: " + output_beta32;

      const outElem1_4b = document.getElementById('fit-LM');
      outElem1_4b.innerText = 'The model has been fitted!';
    }

    //#############################################################
    // 1.5 Plot the fitted lines
    //#############################################################

    window.plotFittedCurves = async function() {
      const graph_title2 = document.getElementById("graph_title2").value || "My Plot";

      const outElem1_5a = document.getElementById('plot-text2');
      outElem1_5a.innerText = 'Plotting the graph, please wait ...';
    
      await webR.evalRVoid(`
          library(ggplot2)
          webr::canvas(width=400, height=300)
          
          p2 <- ggplot(data = data, aes(x = Size, y = Width, color = Type)) + 
            geom_point() + 
            theme_bw() + 
            geom_smooth(method = "lm", se = FALSE) +
            ggtitle(label = as.character(${graph_title2}))
          
          print(p2)
          dev.off()
      `);

      const outElem1_5b = document.getElementById('plot-text2');
      outElem1_5b.innerText = 'Your graph is ready!';

      const msgs = await webR.flush();
      msgs.forEach(msg => {
        if (msg.type === 'canvas' && msg.data.event === 'canvasImage') {
          const canvas = document.getElementById('my_plot_2');
          canvas.getContext('2d').drawImage(msg.data.image, 0, 0);
        }
      });
    }

    //#############################################################
    // 1.6 Save the data
    //#############################################################

    // Function to download the data
    document.getElementById('download-data').addEventListener('click', async () => {
      try {
        // Convert the R data.frame to CSV string
        const csvText = await webR.evalR(`
          results <- model$coefficients
          paste(capture.output(write.csv(results, row.names = TRUE)), collapse = "\n")
        `).then(obj => obj.toArray()).then(arr => arr.join("\n"));

        // Create a Blob and a temporary download link
        const blob = new Blob([csvText], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'coefs_of_LM.csv';
        a.click();
        URL.revokeObjectURL(url);
      } catch (err) {
        console.error(err);
        alert("Error saving CSV: " + err);
      }
    });

    // Function to download canvas as image
    document.getElementById('download-plot').addEventListener('click', () => {
      const canvas = document.getElementById('my_plot_2'); // change if using different canvas
      if (!canvas) {
        alert("Plot not found!");
        return;
      }
      const url = canvas.toDataURL("image/png");
      const a = document.createElement('a');
      a.href = url;
      a.download = 'final_plot.png';
      a.click();
    });

  </script>

  <!-- ################################################### -->
  <!-- ################################################### -->
  <!-- ############# Load multiple data from zip ######### -->
  <!-- ################################################### -->
  <!-- ################################################### -->
  <!-- 1. Load data from a zip -->
<h2 id="datafromzip" style="color:#0d47a1; background-color:#bbdefb; padding:10px; border-radius:8px;">
  1. Load data from a ZIP
</h2>
<p style="font-size:16px; line-height:1.5;">
  In this section, we will work with a custom dataset uploaded as a <code>ZIP</code> file.
  After uploading the ZIP file, we will:
</p>
<ul style="font-size:16px; line-height:1.5; color:#1565c0;">
  <li><b>Visualize the data</b> in a scatter plot to understand its structure.</li>
  <li><b>Fit a linear regression model</b> to investigate the relationships between variables.</li>
  <li><b>Plot the fitted regression lines</b> alongside the original data points for comparison.</li>
</ul>

<!-- 1.1 Load the data -->
<h3 id="loadzip" style="color:#0d47a1; margin-top:20px;">1.1 Upload and extract the ZIP</h3>
<p style="font-size:16px; line-height:1.5;">
  Start by uploading your ZIP file containing the datasets. 
  The ZIP can contain multiple folders; for example, typical folders are <code>Before</code> and <code>After</code>.
  Once uploaded, the files will be extracted into the webR virtual filesystem and listed below.
</p>
<p>Select a ZIP file with your data:</p>
<input type="file" id="zipFile" accept=".zip" style="margin-bottom:10px;"/><br>
<button id="uploadZipBtn" style="background-color:#1565c0; color:white; padding:5px 10px; border:none; border-radius:5px;">Upload and extract</button>
<div>
  <pre style="background-color:#dcf2fc; border:1px solid #84c4f9; padding:10px; border-radius:5px;">
    <code id="zipStatus">No ZIP data uploaded yet.</code>
  </pre>
</div>

<!-- Place lists of files -->
<div id="before-container" style="margin-top:10px; padding:10px; border:1px solid #84c4f9; border-radius:5px; background-color:#e3f2fd;">
  <h5 style="color:#0d47a1;">Files in Before folder:</h5>
  <pre id="before-files">Loading...</pre>
</div>

<div id="after-container" style="margin-top:10px; padding:10px; border:1px solid #84c4f9; border-radius:5px; background-color:#e3f2fd;">
  <h5 style="color:#0d47a1;">Files in After folder:</h5>
  <pre id="after-files">Loading...</pre>
</div>

<!-- 1.2 Select the CSV file -->
<h3 id="SelectCSV" style="color:#0d47a1; margin-top:20px;">1.2 Select the CSV file</h3>
<p style="font-size:16px; line-height:1.5;">
  Now, select a CSV file from one of the extracted folders. 
  Enter the folder name and the CSV filename you want to analyze, then click <code>Load CSV file</code>.
</p>
<p>
  <em>CSV folder:</em> <input type="text" id="SelectedCSVfolder" value="'After'"><br>
  <em>CSV file:</em> <input type="text" id="SelectedCSVfile" value="'data1.csv'"><br><br>
  <button onclick="SelectCSV()" style="background-color:#1565c0; color:white; padding:5px 10px; border:none; border-radius:5px;">
    Load CSV file
  </button>
</p>
<div>
  <pre style="background-color:#dcf2fc; border:1px solid #84c4f9; padding:10px; border-radius:5px;">
    <code id="SelectCSV-text">CSV file not uploaded yet.</code>
  </pre>
</div>

<!-- 1.3 Plot the data -->
<h3 id="plot" style="color:#0d47a1; margin-top:20px;">1.3 Plot the data</h3>
<p style="font-size:16px; line-height:1.5;">
  Visualize the data points in a scatter plot. Enter a title for the graph below and click <code>Plot the data</code>:
</p>
<em>Title for the graph:</em> <input type="text" id="graph_title" value="'Size against width'"><br><br>
<button onclick="plotMyData()" style="background-color:#1565c0; color:white; padding:5px 10px; border:none; border-radius:5px;">
  Plot the data
</button>
<div>
  <pre style="background-color:#dcf2fc; border:1px solid #84c4f9; padding:10px; border-radius:5px;">
    <code id="plot-text">Press <code>Plot the data</code> button to see the graph ...</code>
  </pre>
</div>
<br><br>
<canvas id="my_plot_1" width="1000" height="600" style="border:1px solid #84c4f9; border-radius:5px;"></canvas>

<!-- 1.4 Fitting linear model -->
<h3 id="lm" style="color:#0d47a1; margin-top:20px;">1.4 Fit linear regression model</h3>
<p style="font-size:16px; line-height:1.5;">
  Fit a linear model with interaction terms using the <code>lm()</code> function in R. Click the button below to compute the regression coefficients:
</p>
<button onclick="FitLM()" style="background-color:#1565c0; color:white; padding:5px 10px; border:none; border-radius:5px;">
  Fit linear model
</button>
<div>
  <pre style="background-color:#dcf2fc; border:1px solid #84c4f9; padding:10px; border-radius:5px;">
    <code id="fit-LM">Press <code>"Fit linear model"</code> button to fit the model ...</code>
  </pre>
</div>
<p id="output_beta02" style="font-weight:bold;"></p>
<p id="output_beta12" style="font-weight:bold;"></p>
<p id="output_beta22" style="font-weight:bold;"></p>
<p id="output_beta32" style="font-weight:bold;"></p>

<!-- 1.5 Plot the fitted lines -->
<h3 id="fitplot" style="color:#0d47a1; margin-top:20px;">1.5 Plot the fitted lines</h3>
<p style="font-size:16px; line-height:1.5;">
  Finally, visualize the fitted regression lines along with the data points. You can enter a title for the plot:
</p>
<em>Title for the graph:</em> <input type="text" id="graph_title2" value="'Fitted lines'"><br><br>
<button onclick="plotFittedCurves()" style="background-color:#1565c0; color:white; padding:5px 10px; border:none; border-radius:5px;">
  Plot the fitted lines
</button>
<div>
  <pre style="background-color:#dcf2fc; border:1px solid #84c4f9; padding:10px; border-radius:5px;">
    <code id="plot-text2">Press <code>"Plot the fitted lines"</code> button to see the graph ...</code>
  </pre>
</div>
<br>
<canvas id="my_plot_2" width="1000" height="600" style="border:1px solid #84c4f9; border-radius:5px;"></canvas>

<!-- 1.6 Save the data -->
<h3 id="savedata" style="color:#0d47a1; margin-top:20px;">1.6 Save results</h3>
<p style="font-size:16px; line-height:1.5;">
  You can download the results of your analysis using the buttons below. 
  This includes both the estimated regression coefficients in CSV format and the final plot as an image.
</p>
<button id="download-data" style="background-color:#43a047; color:white; padding:5px 10px; border:none; border-radius:5px;">
  Download regression coefficients (CSV)
</button>
<br><br>
<button id="download-plot" style="background-color:#f4511e; color:white; padding:5px 10px; border:none; border-radius:5px;">
  Download final plot (PNG)
</button>

<p style="margin-top:20px; font-style:italic; color:#0d47a1;">
  Thank you for using this webR interactive analysis! Explore your data, try different CSV files, and see how the model and plots change.
</p>


















</body>
</html>